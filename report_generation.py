# src/report_generation.py - FIXED VERSION
import pandas as pd
import numpy as np
import json
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import os
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

def load_performance_data():
    """Load model performance data"""
    try:
        with open('reports/model_performance.json', 'r') as f:
            performance = json.load(f)
        with open('reports/training_summary.json', 'r') as f:
            summary = json.load(f)
        return performance, summary
    except Exception as e:
        raise Exception(f"Failed to load performance data: {e}")

def load_predictions():
    """Load latest predictions"""
    try:
        with open('predictions/latest_predictions.json', 'r') as f:
            predictions = json.load(f)
        return predictions
    except Exception as e:
        print(f"Warning: Could not load predictions: {e}")
        return None

def load_portfolio_data():
    """Load portfolio optimization data"""
    try:
        with open('portfolio/optimization_results.json', 'r') as f:
            portfolio = json.load(f)
        return portfolio
    except Exception as e:
        print(f"Warning: Could not load portfolio data: {e}")
        return None

# REMOVE this unused function since we're not creating HTML charts
# def create_model_performance_chart(performance_data):
#     ...

def generate_markdown_report():
    """Generate markdown report for GitHub"""
    print("Generating markdown report...")
    
    performance_data, summary_data = load_performance_data()
    predictions_data = load_predictions()
    portfolio_data = load_portfolio_data()
    
    # Find best model
    best_model = max(performance_data.items(), key=lambda x: x[1]['test_profit_score'])
    
    markdown_content = f"""# Financial Analytics Dashboard

**Generated on**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}

## üìä Portfolio Optimization
"""
    
    if portfolio_data:
        markdown_content += f"""
### Performance Metrics
- **Expected Return**: {portfolio_data['performance']['optimal_return']*100:.1f}%
- **Volatility**: {portfolio_data['performance']['optimal_volatility']*100:.1f}%
- **Sharpe Ratio**: {portfolio_data['performance']['optimal_sharpe']:.3f}

### Optimal Allocation
"""
        for asset, weight in portfolio_data['optimal_weights'].items():
            if weight > 0.01:
                markdown_content += f"- **{asset}**: {weight*100:.1f}%\n"
    
    markdown_content += f"""

## üöÄ BTC 7-Day Predictions
"""
    
    if predictions_data:
        recommendation = predictions_data['trading_recommendation']
        
        markdown_content += f"""
### Current Price: ${predictions_data['current_price']:,.2f}
### Model Performance
- **Model**: {predictions_data['model_used']}
- **Profit Score**: {predictions_data['model_performance']['profit_score']:.4f}
- **Accuracy**: {predictions_data['model_performance']['accuracy']*100:.1f}%

### Trading Recommendation: {recommendation['recommendation']}
- **Confidence**: {recommendation['confidence']}
- **Reasoning**: {recommendation['reasoning']}
- **Total 7-Day Return**: {recommendation['total_return']:+.2f}%

### Daily Predictions
| Day | Date | Prediction | Return | Price | Confidence |
|-----|------|------------|--------|-------|------------|
"""
        
        for pred in predictions_data['predictions']:
            markdown_content += f"| {pred['day']} | {pred['date']} | {pred['predicted_direction']} | {pred['predicted_return']:+.2f}% | ${pred['predicted_price']:.2f} | {pred['confidence']} |\n"
    
    markdown_content += f"""

## ü§ñ Model Performance Comparison
"""
    
    for model, metrics in performance_data.items():
        markdown_content += f"""
### {model}
- **Accuracy**: {metrics['test_accuracy']:.3f}
- **F1-Score**: {metrics['test_f1']:.3f}
- **Profit Score**: {metrics['test_profit_score']:.3f}
- **Precision**: {metrics['test_precision']:.3f}
- **Recall**: {metrics['test_recall']:.3f}
"""
    
    markdown_content += f"""

## üìÅ Generated Files

### Portfolio
- `portfolio/optimization_results.json` - Portfolio optimization data

### Predictions
- `predictions/latest_predictions.json` - Latest predictions (JSON)
- `predictions/latest_predictions.csv` - Predictions in CSV format
- `predictions/prediction_visualization.png` - Prediction chart

### Models
- `models/best_model_info.json` - Best model configuration
- `reports/model_performance.json` - Detailed performance metrics
- `reports/dashboard.html` - Interactive dashboard

![Prediction Visualization](predictions/prediction_visualization.png)

---

*Automatically generated by Riverside Data Solutions AI System ‚Ä¢ Updated daily at 15:00 UTC*
"""
    
    # Save markdown report
    with open('README.md', 'w', encoding='utf-8') as f:
        f.write(markdown_content)
    
    print("‚úÖ Complete markdown report generated: README.md")
    return True

def generate_html_report():
    """Generate reports but DON'T overwrite index.html"""
    print("Generating reports...")
    
    # Just generate the markdown report
    # This function is kept for compatibility with existing code
    generate_markdown_report()
    
    print("üìù Note: index.html is preserved (not overwritten)")
    print("‚úÖ Only generating markdown report")
    
    return True

def main():
    """Generate all reports"""
    try:
        print("üöÄ Generating Reports")
        print("="*50)
        
        generate_markdown_report()  # Call this directly
        
        print("\n‚úÖ Reports generated successfully!")
        print("üìù View summary report: README.md")
        print("üåê Your custom index.html is preserved")
        
    except Exception as e:
        print(f"‚ùå Report generation failed: {e}")
        raise

if __name__ == "__main__":
    main()
